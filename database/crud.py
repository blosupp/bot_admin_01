from sqlalchemy import select, update, delete
from database.db import AsyncSessionLocal
from database.models import User, Prompt, Channel
from sqlalchemy.ext.asyncio import AsyncSession
from database.models import Message

# ğŸ‘¤ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚)
async def get_or_create_user(user_id: int, username: str):
    async with AsyncSessionLocal() as session:
        result = await session.execute(select(User).where(User.id == user_id))
        user = result.scalars().first()
        if user:
            return user
        user = User(id=user_id, username=username)
        session.add(user)
        await session.commit()
        return user


async def get_active_prompt(session: AsyncSession, user_id: int) -> Prompt | None:
    result = await session.execute(
        select(Prompt).where(Prompt.user_id == user_id, Prompt.is_active == True)
    )
    return result.scalar_one_or_none()

# âœï¸ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ° (ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ğ½ĞµÑ‚ Ğ½ĞµĞ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼)
async def set_active_prompt(session: AsyncSession, user_id: int, text: str):
    await session.execute(
        update(Prompt)
        .where(Prompt.user_id == user_id, Prompt.is_active == True)
        .values(is_active=False)
    )
    session.add(Prompt(user_id=user_id, text=text, is_active=True))
    await session.commit()

# ğŸ“¡ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ» Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
async def add_channel(owner_id: int | None, title: str, channel_id: int):
    if owner_id is None:
        print("âš ï¸ ĞŸÑƒÑÑ‚Ğ¾Ğ¹ owner_id â€” Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼.")
        return

    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(Channel).where(Channel.owner_id == owner_id, Channel.channel_id == channel_id)
        )
        existing = result.scalar_one_or_none()

        if existing:
            print("âš ï¸ ĞšĞ°Ğ½Ğ°Ğ» ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚.")
            return

        channel = Channel(owner_id=owner_id, title=title, channel_id=channel_id)
        session.add(channel)
        await session.commit()

# ğŸ“‹ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
async def get_user_channels(user_id: int):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(Channel).where(Channel.owner_id == user_id)
        )
        return result.scalars().all()

# ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ»
async def delete_channel(channel_id: int, owner_id: int):
    async with AsyncSessionLocal() as session:
        await session.execute(
            delete(Channel).where(Channel.id == channel_id, Channel.owner_id == owner_id)
        )
        await session.commit()

# ğŸ“‹ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ (Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ²ĞµÑ€Ñ…Ñƒ)
async def get_all_prompts(user_id: int):
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(Prompt)
            .where(Prompt.user_id == user_id)
            .order_by(Prompt.id.desc())
        )
        return result.scalars().all()

# ğŸŸ¢ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¼
async def activate_prompt(prompt_id: int, user_id: int):
    async with AsyncSessionLocal() as session:
        # Ğ¡Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹
        await session.execute(
            update(Prompt)
            .where(Prompt.user_id == user_id)
            .values(is_active=False)
        )
        # ĞĞ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹
        await session.execute(
            update(Prompt)
            .where(Prompt.id == prompt_id, Prompt.user_id == user_id)
            .values(is_active=True)
        )
        await session.commit()

# âŒ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚
async def delete_prompt(prompt_id: int, user_id: int):
    async with AsyncSessionLocal() as session:
        await session.execute(
            delete(Prompt)
            .where(Prompt.id == prompt_id, Prompt.user_id == user_id)
        )
        await session.commit()


# ğŸ’¬ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
async def add_message(session: AsyncSession, user_id: int, role: str, content: str):
    session.add(Message(user_id=user_id, role=role, content=content))
    await session.commit()

# ğŸ§  ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 10 ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
async def get_last_messages(session: AsyncSession, user_id: int, limit: int = 10) -> list[Message]:
    result = await session.execute(
        select(Message)
        .where(Message.user_id == user_id)
        .order_by(Message.id.desc())
        .limit(limit)
    )
    return list(reversed(result.scalars().all()))
